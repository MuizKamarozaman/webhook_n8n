<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson Plan Data Extractor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.14/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 1000px; margin: 0 auto; padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container { 
            background: white; padding: 30px; border-radius: 16px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1); 
        }
        h2 { 
            color: #2c3e50; text-align: center; margin-bottom: 30px; 
            font-size: 1.8em; font-weight: 600;
        }
        .upload-section { 
            display: grid; grid-template-columns: 1fr 1fr; 
            gap: 20px; margin-bottom: 30px; 
        }
        @media (max-width: 768px) {
            .upload-section { grid-template-columns: 1fr; }
        }
        .upload-box { 
            border: 2px dashed #3498db; border-radius: 12px; 
            padding: 20px; text-align: center; 
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .upload-box::before {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%; 
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }
        .upload-box:hover::before { left: 100%; }
        .upload-box:hover { border-color: #2980b9; transform: translateY(-2px); }
        .upload-box.filled { border-color: #27ae60; background: #f8fff8; }
        .upload-box.error { border-color: #e74c3c; background: #fff5f5; }
        .upload-box h3 { margin: 0 0 15px 0; color: #34495e; font-size: 1.1em; }
        input[type="file"] { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 8px; background: #f8f9fa; 
            font-size: 0.9em; cursor: pointer;
        }
        input[type="file"]:hover { background: #e9ecef; }
        .file-info { 
            margin-top: 10px; font-size: 0.85em; 
            color: #6c757d; font-weight: 500; 
        }
        .process-btn { 
            background: linear-gradient(135deg, #3498db, #2980b9); 
            color: white; padding: 15px 40px; border: none; 
            border-radius: 12px; cursor: pointer; font-size: 16px; 
            width: 100%; font-weight: 600; letter-spacing: 0.5px;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        .process-btn:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4); 
        }
        .process-btn:disabled { 
            background: #bdc3c7; cursor: not-allowed; 
            transform: none; box-shadow: none; 
        }
        #status { 
            margin-top: 20px; padding: 15px; border-radius: 8px; 
            font-weight: 600; text-align: center; 
        }
        .status-loading { background: #f39c12; color: white; }
        .status-success { background: #27ae60; color: white; }
        .status-error { background: #e74c3c; color: white; }
        .results { 
            margin-top: 30px; padding: 20px; background: #f8f9fa; 
            border-radius: 12px; display: none; text-align: center;
        }
        .download-btn { 
            background: linear-gradient(135deg, #27ae60, #2ecc71); 
            color: white; padding: 12px 25px; border: none; 
            border-radius: 8px; cursor: pointer; font-size: 16px; 
            text-decoration: none; display: inline-block; font-weight: 600;
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        .download-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4); 
        }
        .preview { 
            margin-top: 20px; padding: 20px; background: #f8f9fa; 
            border-radius: 12px; border-left: 4px solid #17a2b8; 
        }
        .preview h4 { margin-top: 0; color: #17a2b8; font-size: 1.1em; }
        .preview-content { 
            font-size: 0.9em; color: #495057; 
            max-height: 250px; overflow-y: auto; 
            line-height: 1.5;
        }
        .validation-info { 
            margin-top: 10px; padding: 10px; 
            background: #fff3cd; border-left: 4px solid #ffc107; 
            border-radius: 4px; font-size: 0.85em; color: #856404; 
        }
        .placeholder-preview { 
            margin-top: 15px; padding: 15px; 
            background: #d4edda; border-left: 4px solid #28a745; 
            border-radius: 8px; 
        }
        .placeholder-preview h5 { 
            margin-top: 0; color: #155724; font-size: 0.95em; 
        }
        .placeholder-list { 
            max-height: 150px; overflow-y: auto; 
            font-size: 0.8em; line-height: 1.4; 
        }
        .placeholder-list code {
            background: #f8f9fa; padding: 2px 6px; 
            border-radius: 4px; margin: 0 4px 4px 0; 
            display: inline-block; border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üìö Lesson Plan Data Extractor & Template Filler</h2>
       
        <div class="upload-section">
            <div class="upload-box" id="lessonPlanUploadBox">
                <h3>üìÑ Lesson Plan (.docx)</h3>
                <input type="file" id="lessonPlanFile" accept=".docx">
                <div class="file-info" id="lessonPlanFileInfo">No file selected</div>
                <div class="validation-info" id="lessonPlanValidation" style="display: none;"></div>
            </div>
           
            <div class="upload-box" id="templateUploadBox">
                <h3>üìã Empty Template (.docx)</h3>
                <input type="file" id="templateFile" accept=".docx">
                <div class="file-info" id="templateFileInfo">No file selected</div>
                <div class="validation-info" id="templateValidation" style="display: none;"></div>
                <div class="placeholder-preview" id="templatePlaceholders" style="display: none;">
                    <h5>üîç Found Placeholders:</h5>
                    <div class="placeholder-list" id="placeholderList"></div>
                </div>
            </div>
        </div>
       
        <button class="process-btn" id="processBtn" disabled>üîÑ Process Files</button>
       
        <div id="status"></div>
       
        <div class="preview" id="extractedPreview" style="display: none;">
            <h4>üìä Extracted Data Preview</h4>
            <div class="preview-content" id="previewContent"></div>
        </div>
       
        <div class="results" id="results">
            <h3>‚úÖ Success!</h3>
            <p>Your template has been filled with the extracted data.</p>
            <a href="#" id="downloadLink" class="download-btn" download>üì• Download Filled Template</a>
        </div>
    </div>

    <script>
        // DOM Elements
        const elements = {
            lessonPlanFile: document.getElementById('lessonPlanFile'),
            templateFile: document.getElementById('templateFile'),
            lessonPlanFileInfo: document.getElementById('lessonPlanFileInfo'),
            templateFileInfo: document.getElementById('templateFileInfo'),
            lessonPlanUploadBox: document.getElementById('lessonPlanUploadBox'),
            templateUploadBox: document.getElementById('templateUploadBox'),
            lessonPlanValidation: document.getElementById('lessonPlanValidation'),
            templateValidation: document.getElementById('templateValidation'),
            templatePlaceholders: document.getElementById('templatePlaceholders'),
            placeholderList: document.getElementById('placeholderList'),
            processBtn: document.getElementById('processBtn'),
            status: document.getElementById('status'),
            results: document.getElementById('results'),
            downloadLink: document.getElementById('downloadLink'),
            extractedPreview: document.getElementById('extractedPreview'),
            previewContent: document.getElementById('previewContent')
        };

        // State
        let state = {
            lessonPlanContent: null,
            templateBase64: null,
            templateName: null,
            extractedData: null,
            templatePlaceholders: []
        };

        // Configuration
        const config = {
            webhookUrl: "https://n8n.jiosgroup.com/webhook-test/096306be-c7d5-4576-afe5-8aa2f3f04ee2"
        };

        // Utility Functions
        function validateDocxFile(arrayBuffer) {
            try {
                const uint8Array = new Uint8Array(arrayBuffer);
                const zipSignature = [0x50, 0x4B, 0x03, 0x04];
                const hasZipSignature = zipSignature.every((byte, index) => uint8Array[index] === byte);
                
                if (!hasZipSignature) return { valid: false, reason: "Invalid DOCX format" };
                if (arrayBuffer.byteLength < 1000) return { valid: false, reason: "File too small" };
                
                return { valid: true };
            } catch (error) {
                return { valid: false, reason: "File validation error: " + error.message };
            }
        }

        async function extractPlaceholdersFromTemplate(arrayBuffer) {
            try {
                const zip = await JSZip.loadAsync(arrayBuffer);
                const documentXml = await zip.file('word/document.xml').async('text');
                
                const patterns = [
                    /\{\{([^}]+)\}\}/g,
                    /\(\(([^)]+)\)\)/g,
                    /\{([^}]+)\}/g,
                    /\[([^\]]+)\]/g
                ];
                
                const placeholders = new Set();
                
                patterns.forEach(pattern => {
                    let match;
                    while ((match = pattern.exec(documentXml)) !== null) {
                        const fullMatch = match[0];
                        const innerText = match[1];
                        
                        if (innerText.length > 2 && innerText.length < 50 && 
                            !innerText.includes('<') && !innerText.includes('>') &&
                            !innerText.match(/^\d+$/)) {
                            placeholders.add(fullMatch);
                        }
                    }
                });
                
                return Array.from(placeholders);
            } catch (error) {
                console.error('Error extracting placeholders:', error);
                return [];
            }
        }

        function extractLessonPlanData(content) {
            const data = { header: {}, activities: [] };
            
            const headerPatterns = {
                subject: /(?:SUBJECT|Subject)[:\s]+([^\r\n]+)/i,
                week: /(?:WEEK|Week)[:\s]+([^\r\n]+)/i,
                date: /(?:DATE|Date)[:\s]+([^\r\n]+)/i,
                day: /(?:DAY|Day)[:\s]+([^\r\n]+)/i,
                time: /(?:TIME|Time)[:\s]+([^\r\n]+)/i,
                class: /(?:CLASS|Class)[:\s]+([^\r\n]+)/i,
                unit: /(?:UNIT|Unit)[:\s]+([^\r\n]+)/i,
                topic: /(?:TOPIC|Topic)[:\s]+([^\r\n]+)/i,
                content_standard: /(?:CONTENT STANDARD|Content Standard)[:\s]+([^\r\n]+)/i,
                learning_standard: /(?:LEARNING STANDARD|Learning Standard)[:\s]+([^\r\n]+)/i,
                learning_objectives: /(?:LEARNING OBJECTIVES|Learning Objectives)[:\s]+([^\r\n]+)/i
            };

            // Extract header fields
            Object.entries(headerPatterns).forEach(([key, pattern]) => {
                const match = content.match(pattern);
                if (match) data.header[key] = match[1].trim();
            });

            // Extract activities
            const activitySections = [
                {
                    type: 'Pre Lesson',
                    pattern: /(?:PRE.?LESSON|Pre.?Lesson|INTRODUCTION|Introduction)[:\s]*\n([\s\S]*?)(?=(?:LESSON DEVELOPMENT|Lesson Development|MAIN ACTIVITIES|Main Activities|POST.?LESSON|Post.?Lesson)|$)/i
                },
                {
                    type: 'Lesson Development',
                    pattern: /(?:LESSON DEVELOPMENT|Lesson Development|MAIN ACTIVITIES|Main Activities)[:\s]*\n([\s\S]*?)(?=(?:POST.?LESSON|Post.?Lesson|CLOSURE|Closure)|$)/i
                },
                {
                    type: 'Post Lesson',
                    pattern: /(?:POST.?LESSON|Post.?Lesson|CLOSURE|Closure)[:\s]*\n([\s\S]*?)$/i
                }
            ];

            activitySections.forEach(section => {
                const match = content.match(section.pattern);
                if (match && match[1]) {
                    const items = parseActivityItems(match[1].trim());
                    if (items.length > 0) {
                        data.activities.push({ type: section.type, items });
                    }
                }
            });

            return data;
        }

        function parseActivityItems(text) {
            const lines = text.split(/\n+/).map(line => line.trim()).filter(line => line.length > 0);
            const items = [];
            let currentActivity = null;
            
            lines.forEach(line => {
                if (line.match(/^(?:Activity|ACTIVITY)\s+\d+/i)) {
                    if (currentActivity) items.push(currentActivity);
                    currentActivity = line;
                } else if (line.match(/^\d+\.\s/) || line.match(/^[a-z]\)\s/i) || line.match(/^[-‚Ä¢]\s/)) {
                    if (currentActivity) {
                        currentActivity += '\n' + line;
                    } else {
                        items.push(line);
                    }
                } else if (line.length > 10) {
                    if (currentActivity) {
                        currentActivity += '\n' + line;
                    } else {
                        items.push(line);
                    }
                }
            });
            
            if (currentActivity) items.push(currentActivity);
            return items.filter(item => item.length > 5);
        }

        function updateStatus(message, type) {
            elements.status.textContent = message;
            elements.status.className = `status-${type}`;
        }

        function showExtractedPreview(content, data) {
            let html = `<strong>Extracted Data:</strong><br>`;
            
            if (data?.header) {
                html += `<strong>Header Fields (${Object.keys(data.header).length}):</strong><br>`;
                Object.entries(data.header).forEach(([key, value]) => {
                    if (value) html += `<strong>${key}:</strong> ${value}<br>`;
                });
            }
            
            if (data?.activities) {
                html += `<br><strong>Activities (${data.activities.length}):</strong><br>`;
                data.activities.forEach(activity => {
                    html += `<strong>${activity.type}:</strong> ${activity.items.length} items<br>`;
                });
            }
            
            html += `<br><strong>Content Length:</strong> ${content.length} characters`;
            
            elements.previewContent.innerHTML = html;
            elements.extractedPreview.style.display = 'block';
        }

        function checkIfReady() {
            const ready = state.lessonPlanContent && state.templateBase64 && state.extractedData;
            elements.processBtn.disabled = !ready;
            elements.processBtn.textContent = ready 
                ? `üîÑ Process ${state.templatePlaceholders.length} Placeholders` 
                : 'üîÑ Process Files';
        }

        // Event Handlers
        elements.lessonPlanFile.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                elements.lessonPlanFileInfo.textContent = "No file selected";
                elements.lessonPlanUploadBox.classList.remove('filled', 'error');
                elements.lessonPlanValidation.style.display = 'none';
                state.lessonPlanContent = null;
                state.extractedData = null;
                elements.extractedPreview.style.display = 'none';
                checkIfReady();
                return;
            }

            elements.lessonPlanFileInfo.textContent = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
            elements.lessonPlanUploadBox.classList.remove('error');
            elements.lessonPlanUploadBox.classList.add('filled');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const validation = validateDocxFile(e.target.result);
                if (!validation.valid) {
                    elements.lessonPlanValidation.textContent = `‚ö†Ô∏è ${validation.reason}`;
                    elements.lessonPlanValidation.style.display = 'block';
                    elements.lessonPlanUploadBox.classList.add('error');
                    elements.lessonPlanUploadBox.classList.remove('filled');
                    checkIfReady();
                    return;
                }

                elements.lessonPlanValidation.style.display = 'none';
                
                try {
                    const result = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                    state.lessonPlanContent = result.value;
                    state.extractedData = extractLessonPlanData(state.lessonPlanContent);
                    
                    updateStatus(`‚úÖ Lesson plan processed (${state.lessonPlanContent.length} characters)`, "success");
                    showExtractedPreview(state.lessonPlanContent, state.extractedData);
                    checkIfReady();
                } catch (error) {
                    console.error("Text extraction failed:", error);
                    updateStatus("‚ùå Error extracting text from lesson plan", "error");
                    elements.lessonPlanUploadBox.classList.add('error');
                    elements.lessonPlanUploadBox.classList.remove('filled');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        elements.templateFile.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) {
                elements.templateFileInfo.textContent = "No file selected";
                elements.templateUploadBox.classList.remove('filled', 'error');
                elements.templateValidation.style.display = 'none';
                elements.templatePlaceholders.style.display = 'none';
                state.templateBase64 = null;
                state.templateName = null;
                state.templatePlaceholders = [];
                checkIfReady();
                return;
            }

            elements.templateFileInfo.textContent = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
            elements.templateUploadBox.classList.remove('error');
            elements.templateUploadBox.classList.add('filled');
            state.templateName = file.name;

            const reader = new FileReader();
            reader.onload = async (e) => {
                const validation = validateDocxFile(e.target.result);
                if (!validation.valid) {
                    elements.templateValidation.textContent = `‚ö†Ô∏è ${validation.reason}`;
                    elements.templateValidation.style.display = 'block';
                    elements.templateUploadBox.classList.add('error');
                    elements.templateUploadBox.classList.remove('filled');
                    checkIfReady();
                    return;
                }

                elements.templateValidation.style.display = 'none';
                
                try {
                    state.templatePlaceholders = await extractPlaceholdersFromTemplate(e.target.result);
                    
                    if (state.templatePlaceholders.length > 0) {
                        elements.placeholderList.innerHTML = state.templatePlaceholders
                            .map(p => `<code>${p}</code>`).join(' ');
                        elements.templatePlaceholders.style.display = 'block';
                    } else {
                        elements.templatePlaceholders.style.display = 'none';
                    }
                    
                    state.templateBase64 = btoa(
                        new Uint8Array(e.target.result)
                            .reduce((data, byte) => data + String.fromCharCode(byte), '')
                    );
                    
                    updateStatus(`‚úÖ Template uploaded (${state.templatePlaceholders.length} placeholders found)`, "success");
                    checkIfReady();
                } catch (error) {
                    console.error("Template processing error:", error);
                    elements.templateValidation.textContent = `‚ö†Ô∏è ${error.message}`;
                    elements.templateValidation.style.display = 'block';
                    elements.templateUploadBox.classList.add('error');
                    elements.templateUploadBox.classList.remove('filled');
                    checkIfReady();
                }
            };
            reader.readAsArrayBuffer(file);
        });

        elements.processBtn.addEventListener('click', async () => {
            if (!state.lessonPlanContent || !state.templateBase64 || !state.extractedData) {
                updateStatus("‚ùå Please upload both files", "error");
                return;
            }

            updateStatus("üîÑ Processing documents...", "loading");
            elements.processBtn.disabled = true;
            elements.results.style.display = 'none';

            try {
                const payload = {
                    fileContent: state.lessonPlanContent,
                    extractedData: state.extractedData,
                    templateBase64: state.templateBase64,
                    templateName: state.templateName,
                    templatePlaceholders: state.templatePlaceholders,
                    timestamp: new Date().toISOString()
                };

                const response = await fetch(config.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    updateStatus(`‚úÖ Success! ${data.templateInfo?.placeholdersReplaced || 0} replacements made`, "success");
                    elements.results.style.display = 'block';
                    
                    if (data.downloadUrl) {
                        elements.downloadLink.href = data.downloadUrl;
                        elements.downloadLink.download = data.fileName || 'filled_lesson_plan.docx';
                    }
                } else {
                    updateStatus("‚ùå Processing failed: " + (data.error || "Unknown error"), "error");
                }
            } catch (error) {
                console.error("Fetch error:", error);
                updateStatus("‚ùå Network error occurred", "error");
            } finally {
                elements.processBtn.disabled = false;
                checkIfReady();
            }
        });
    </script>
</body>
</html>